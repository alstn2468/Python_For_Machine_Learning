
Chapter 5<br/>
< Pandas #2 >
===============================

[[실행 코드]](https://github.com/alstn2468/Python_For_Machine_Learning/blob/master/Chapter.5/3.ipynb)


### Groupby
- SQL groupby 명령어와 같음
- split -> apply -> combine<br/>
과정을 거쳐 연산


```python
import pandas as pd

ipl_data = {'Team': ['Riders', 'Riders', 'Devils', 'Devils', 'Kings',
                     'kings', 'Kings', 'Kings', 'Riders', 'Royals', 'Royals', 'Riders'],
            'Rank': [1, 2, 2, 3, 3, 4 ,1 ,1, 2 , 4, 1, 2],
            'Year': [2014, 2015, 2014, 2015, 2014, 2015, 2016, 2017, 2016, 2014, 2015, 2017],
            'Points':[876, 789, 863, 673, 741, 812, 756, 788, 694, 701, 804, 690]}

df = pd.DataFrame(ipl_data)
df
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Points</th>
      <th>Rank</th>
      <th>Team</th>
      <th>Year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>876</td>
      <td>1</td>
      <td>Riders</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>1</th>
      <td>789</td>
      <td>2</td>
      <td>Riders</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>2</th>
      <td>863</td>
      <td>2</td>
      <td>Devils</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>3</th>
      <td>673</td>
      <td>3</td>
      <td>Devils</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>4</th>
      <td>741</td>
      <td>3</td>
      <td>Kings</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>5</th>
      <td>812</td>
      <td>4</td>
      <td>kings</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>6</th>
      <td>756</td>
      <td>1</td>
      <td>Kings</td>
      <td>2016</td>
    </tr>
    <tr>
      <th>7</th>
      <td>788</td>
      <td>1</td>
      <td>Kings</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>8</th>
      <td>694</td>
      <td>2</td>
      <td>Riders</td>
      <td>2016</td>
    </tr>
    <tr>
      <th>9</th>
      <td>701</td>
      <td>4</td>
      <td>Royals</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>10</th>
      <td>804</td>
      <td>1</td>
      <td>Royals</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>11</th>
      <td>690</td>
      <td>2</td>
      <td>Riders</td>
      <td>2017</td>
    </tr>
  </tbody>
</table>
</div>



- 묶음의 기준이 되는 컬럼 : Team
- 적용받는 컬럼 : Points
- 적용받는 연산 : sum()
- 결과 : Team을 기준으로 Points를 Sum


```python
df.groupby("Team")["Points"].sum()
```




    Team
    Devils    1536
    Kings     2285
    Riders    3049
    Royals    1505
    kings      812
    Name: Points, dtype: int64



- 1개 이상의 column을 묶을 수 있다.


```python
df.groupby(['Team', 'Year'])['Points'].sum()
```




    Team    Year
    Devils  2014    863
            2015    673
    Kings   2014    741
            2016    756
            2017    788
    Riders  2014    876
            2015    789
            2016    694
            2017    690
    Royals  2014    701
            2015    804
    kings   2015    812
    Name: Points, dtype: int64



### Hierarchical index
- Groupby 명령의 결과물은 DataFrame
- 2개의 column으로 groupby를 할 경우, index가 2개 생성


```python
h_index = df.groupby(["Team", "Year"])["Points"].sum()
h_index
```




    Team    Year
    Devils  2014    863
            2015    673
    Kings   2014    741
            2016    756
            2017    788
    Riders  2014    876
            2015    789
            2016    694
            2017    690
    Royals  2014    701
            2015    804
    kings   2015    812
    Name: Points, dtype: int64




```python
h_index.index
```




    MultiIndex(levels=[['Devils', 'Kings', 'Riders', 'Royals', 'kings'], [2014, 2015, 2016, 2017]],
               labels=[[0, 0, 1, 1, 1, 2, 2, 2, 2, 3, 3, 4], [0, 1, 0, 2, 3, 0, 1, 2, 3, 0, 1, 1]],
               names=['Team', 'Year'])




```python
h_index['Devils' : 'Kings']
```




    Team    Year
    Devils  2014    863
            2015    673
    Kings   2014    741
            2016    756
            2017    788
    Name: Points, dtype: int64



#### Hierarchical index - unstack()
- Group으로 묶여진 데이터를 matrix형태로 전환


```python
h_index.unstack()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Year</th>
      <th>2014</th>
      <th>2015</th>
      <th>2016</th>
      <th>2017</th>
    </tr>
    <tr>
      <th>Team</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Devils</th>
      <td>863.0</td>
      <td>673.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Kings</th>
      <td>741.0</td>
      <td>NaN</td>
      <td>756.0</td>
      <td>788.0</td>
    </tr>
    <tr>
      <th>Riders</th>
      <td>876.0</td>
      <td>789.0</td>
      <td>694.0</td>
      <td>690.0</td>
    </tr>
    <tr>
      <th>Royals</th>
      <td>701.0</td>
      <td>804.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>kings</th>
      <td>NaN</td>
      <td>812.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>



### Hierarchical index  - swaplevel
- index level을 변경할 수 있다.


```python
h_index.swaplevel()
```




    Year  Team  
    2014  Devils    863
    2015  Devils    673
    2014  Kings     741
    2016  Kings     756
    2017  Kings     788
    2014  Riders    876
    2015  Riders    789
    2016  Riders    694
    2017  Riders    690
    2014  Royals    701
    2015  Royals    804
          kings     812
    Name: Points, dtype: int64




```python
h_index.swaplevel().sortlevel(0)
```

    /anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:1: FutureWarning: sortlevel is deprecated, use sort_index(level=...)
      """Entry point for launching an IPython kernel.





    Year  Team  
    2014  Devils    863
          Kings     741
          Riders    876
          Royals    701
    2015  Devils    673
          Riders    789
          Royals    804
          kings     812
    2016  Kings     756
          Riders    694
    2017  Kings     788
          Riders    690
    Name: Points, dtype: int64



### Hierarchical index - operations
- index level을 기준으로 기본 연산 수행 가능


```python
h_index.sum(level = 0)
```




    Team
    Devils    1536
    Kings     2285
    Riders    3049
    Royals    1505
    kings      812
    Name: Points, dtype: int64




```python
h_index.sum(level = 1)
```




    Year
    2014    3181
    2015    3078
    2016    1450
    2017    1478
    Name: Points, dtype: int64



### Groupby - grouped
- Groupby에 의해 Split된 상태를 추출 가능
- Tuple 형태로 그룹의 key값, value값이 추출


```python
grouped = df.groupby('Team')

for name, group in grouped :
    print(name)
    print(type(name))
    print(group)
    print(type(group))
```

    Devils
    <class 'str'>
       Points  Rank    Team  Year
    2     863     2  Devils  2014
    3     673     3  Devils  2015
    <class 'pandas.core.frame.DataFrame'>
    Kings
    <class 'str'>
       Points  Rank   Team  Year
    4     741     3  Kings  2014
    6     756     1  Kings  2016
    7     788     1  Kings  2017
    <class 'pandas.core.frame.DataFrame'>
    Riders
    <class 'str'>
        Points  Rank    Team  Year
    0      876     1  Riders  2014
    1      789     2  Riders  2015
    8      694     2  Riders  2016
    11     690     2  Riders  2017
    <class 'pandas.core.frame.DataFrame'>
    Royals
    <class 'str'>
        Points  Rank    Team  Year
    9      701     4  Royals  2014
    10     804     1  Royals  2015
    <class 'pandas.core.frame.DataFrame'>
    kings
    <class 'str'>
       Points  Rank   Team  Year
    5     812     4  kings  2015
    <class 'pandas.core.frame.DataFrame'>


- 특정 key값을 가진 그룹의 정보만 추출 가능


```python
grouped.get_group('Devils')
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Points</th>
      <th>Rank</th>
      <th>Team</th>
      <th>Year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>863</td>
      <td>2</td>
      <td>Devils</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>3</th>
      <td>673</td>
      <td>3</td>
      <td>Devils</td>
      <td>2015</td>
    </tr>
  </tbody>
</table>
</div>



- 추출된 group 정보에는 세 가지 유형의 apply가 가능
- Aggregation : 요약된 통계정보 추출
- Transformation : 해당 정보를 변환
- Filtration : 특정 정보를 제거하여 보여주는 필터링 기능

### Groupby - aggregation


```python
grouped.agg(sum)
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Points</th>
      <th>Rank</th>
      <th>Year</th>
    </tr>
    <tr>
      <th>Team</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Devils</th>
      <td>1536</td>
      <td>5</td>
      <td>4029</td>
    </tr>
    <tr>
      <th>Kings</th>
      <td>2285</td>
      <td>5</td>
      <td>6047</td>
    </tr>
    <tr>
      <th>Riders</th>
      <td>3049</td>
      <td>7</td>
      <td>8062</td>
    </tr>
    <tr>
      <th>Royals</th>
      <td>1505</td>
      <td>5</td>
      <td>4029</td>
    </tr>
    <tr>
      <th>kings</th>
      <td>812</td>
      <td>4</td>
      <td>2015</td>
    </tr>
  </tbody>
</table>
</div>




```python
import numpy as np
grouped.agg(np.mean)
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Points</th>
      <th>Rank</th>
      <th>Year</th>
    </tr>
    <tr>
      <th>Team</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Devils</th>
      <td>768.000000</td>
      <td>2.500000</td>
      <td>2014.500000</td>
    </tr>
    <tr>
      <th>Kings</th>
      <td>761.666667</td>
      <td>1.666667</td>
      <td>2015.666667</td>
    </tr>
    <tr>
      <th>Riders</th>
      <td>762.250000</td>
      <td>1.750000</td>
      <td>2015.500000</td>
    </tr>
    <tr>
      <th>Royals</th>
      <td>752.500000</td>
      <td>2.500000</td>
      <td>2014.500000</td>
    </tr>
    <tr>
      <th>kings</th>
      <td>812.000000</td>
      <td>4.000000</td>
      <td>2015.000000</td>
    </tr>
  </tbody>
</table>
</div>



- 특정 column에 여러개의 function을 적용 가능


```python
grouped['Points'].agg([np.sum, np.mean, np.std])
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>std</th>
    </tr>
    <tr>
      <th>Team</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Devils</th>
      <td>1536</td>
      <td>768.000000</td>
      <td>134.350288</td>
    </tr>
    <tr>
      <th>Kings</th>
      <td>2285</td>
      <td>761.666667</td>
      <td>24.006943</td>
    </tr>
    <tr>
      <th>Riders</th>
      <td>3049</td>
      <td>762.250000</td>
      <td>88.567771</td>
    </tr>
    <tr>
      <th>Royals</th>
      <td>1505</td>
      <td>752.500000</td>
      <td>72.831998</td>
    </tr>
    <tr>
      <th>kings</th>
      <td>812</td>
      <td>812.000000</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>



### Groupby - transformation
- Aggregation과 달리 key값 별로 요약된 정보가 아니다.
- 개별 데이터의 변환을 지원


```python
df
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Points</th>
      <th>Rank</th>
      <th>Team</th>
      <th>Year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>876</td>
      <td>1</td>
      <td>Riders</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>1</th>
      <td>789</td>
      <td>2</td>
      <td>Riders</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>2</th>
      <td>863</td>
      <td>2</td>
      <td>Devils</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>3</th>
      <td>673</td>
      <td>3</td>
      <td>Devils</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>4</th>
      <td>741</td>
      <td>3</td>
      <td>Kings</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>5</th>
      <td>812</td>
      <td>4</td>
      <td>kings</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>6</th>
      <td>756</td>
      <td>1</td>
      <td>Kings</td>
      <td>2016</td>
    </tr>
    <tr>
      <th>7</th>
      <td>788</td>
      <td>1</td>
      <td>Kings</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>8</th>
      <td>694</td>
      <td>2</td>
      <td>Riders</td>
      <td>2016</td>
    </tr>
    <tr>
      <th>9</th>
      <td>701</td>
      <td>4</td>
      <td>Royals</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>10</th>
      <td>804</td>
      <td>1</td>
      <td>Royals</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>11</th>
      <td>690</td>
      <td>2</td>
      <td>Riders</td>
      <td>2017</td>
    </tr>
  </tbody>
</table>
</div>




```python
score = lambda x : (x)
grouped.transform(score)
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Points</th>
      <th>Rank</th>
      <th>Year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>876</td>
      <td>1</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>1</th>
      <td>789</td>
      <td>2</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>2</th>
      <td>863</td>
      <td>2</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>3</th>
      <td>673</td>
      <td>3</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>4</th>
      <td>741</td>
      <td>3</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>5</th>
      <td>812</td>
      <td>4</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>6</th>
      <td>756</td>
      <td>1</td>
      <td>2016</td>
    </tr>
    <tr>
      <th>7</th>
      <td>788</td>
      <td>1</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>8</th>
      <td>694</td>
      <td>2</td>
      <td>2016</td>
    </tr>
    <tr>
      <th>9</th>
      <td>701</td>
      <td>4</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>10</th>
      <td>804</td>
      <td>1</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>11</th>
      <td>690</td>
      <td>2</td>
      <td>2017</td>
    </tr>
  </tbody>
</table>
</div>



- 단 max나 min처럼 Series 데이터에 적용되는<br/>
데이터들은 Key값을 기준으로 Grouped된 데이터 기준


```python
score = lambda x : (x.max())
grouped.transform(score)
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Points</th>
      <th>Rank</th>
      <th>Year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>876</td>
      <td>2</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>1</th>
      <td>876</td>
      <td>2</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>2</th>
      <td>863</td>
      <td>3</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>3</th>
      <td>863</td>
      <td>3</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>4</th>
      <td>788</td>
      <td>3</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>5</th>
      <td>812</td>
      <td>4</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>6</th>
      <td>788</td>
      <td>3</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>7</th>
      <td>788</td>
      <td>3</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>8</th>
      <td>876</td>
      <td>2</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>9</th>
      <td>804</td>
      <td>4</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>10</th>
      <td>804</td>
      <td>4</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>11</th>
      <td>876</td>
      <td>2</td>
      <td>2017</td>
    </tr>
  </tbody>
</table>
</div>




```python
score = lambda x : (x - x.mean()) / x.std()
grouped.transform(score)
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Points</th>
      <th>Rank</th>
      <th>Year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.284327</td>
      <td>-1.500000</td>
      <td>-1.161895</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.302029</td>
      <td>0.500000</td>
      <td>-0.387298</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.707107</td>
      <td>-0.707107</td>
      <td>-0.707107</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.707107</td>
      <td>0.707107</td>
      <td>0.707107</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.860862</td>
      <td>1.154701</td>
      <td>-1.091089</td>
    </tr>
    <tr>
      <th>5</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-0.236043</td>
      <td>-0.577350</td>
      <td>0.218218</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1.096905</td>
      <td>-0.577350</td>
      <td>0.872872</td>
    </tr>
    <tr>
      <th>8</th>
      <td>-0.770596</td>
      <td>0.500000</td>
      <td>0.387298</td>
    </tr>
    <tr>
      <th>9</th>
      <td>-0.707107</td>
      <td>0.707107</td>
      <td>-0.707107</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.707107</td>
      <td>-0.707107</td>
      <td>0.707107</td>
    </tr>
    <tr>
      <th>11</th>
      <td>-0.815759</td>
      <td>0.500000</td>
      <td>1.161895</td>
    </tr>
  </tbody>
</table>
</div>



### Groupby - filter
- 특정 조건으로 데이터를 검색할 때 사용
- filter안에는 boolean 조건이 존재해야한다.
- len(x)는 grouped된 DataFrame 개수


```python
df.groupby('Team').filter(lambda x : len(x) >= 3)
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Points</th>
      <th>Rank</th>
      <th>Team</th>
      <th>Year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>876</td>
      <td>1</td>
      <td>Riders</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>1</th>
      <td>789</td>
      <td>2</td>
      <td>Riders</td>
      <td>2015</td>
    </tr>
    <tr>
      <th>4</th>
      <td>741</td>
      <td>3</td>
      <td>Kings</td>
      <td>2014</td>
    </tr>
    <tr>
      <th>6</th>
      <td>756</td>
      <td>1</td>
      <td>Kings</td>
      <td>2016</td>
    </tr>
    <tr>
      <th>7</th>
      <td>788</td>
      <td>1</td>
      <td>Kings</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>8</th>
      <td>694</td>
      <td>2</td>
      <td>Riders</td>
      <td>2016</td>
    </tr>
    <tr>
      <th>11</th>
      <td>690</td>
      <td>2</td>
      <td>Riders</td>
      <td>2017</td>
    </tr>
  </tbody>
</table>
</div>



### Data
- 시간과 데이터 종류가 정리된 통화량 데이터


```python
import dateutil

df_phone = pd.read_csv('./data/phone_data.csv')
df_phone['date'] = df_phone['date'].apply(dateutil.parser.parse, dayfirst = True)
df_phone.head()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>date</th>
      <th>duration</th>
      <th>item</th>
      <th>month</th>
      <th>network</th>
      <th>network_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>2014-10-15 06:58:00</td>
      <td>34.429</td>
      <td>data</td>
      <td>2014-11</td>
      <td>data</td>
      <td>data</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2014-10-15 06:58:00</td>
      <td>13.000</td>
      <td>call</td>
      <td>2014-11</td>
      <td>Vodafone</td>
      <td>mobile</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>2014-10-15 14:46:00</td>
      <td>23.000</td>
      <td>call</td>
      <td>2014-11</td>
      <td>Meteor</td>
      <td>mobile</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>2014-10-15 14:48:00</td>
      <td>4.000</td>
      <td>call</td>
      <td>2014-11</td>
      <td>Tesco</td>
      <td>mobile</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>2014-10-15 17:27:00</td>
      <td>4.000</td>
      <td>call</td>
      <td>2014-11</td>
      <td>Tesco</td>
      <td>mobile</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_phone.groupby('month')['duration'].sum()
```




    month
    2014-11    26639.441
    2014-12    14641.870
    2015-01    18223.299
    2015-02    15522.299
    2015-03    22750.441
    Name: duration, dtype: float64




```python
df_phone[df_phone['item'] == 'call'].groupby('network')['duration'].sum()
```




    network
    Meteor        7200.0
    Tesco        13828.0
    Three        36464.0
    Vodafone     14621.0
    landline     18433.0
    voicemail     1775.0
    Name: duration, dtype: float64




```python
df_phone.groupby(['month', 'item'])['date'].count()
```




    month    item
    2014-11  call    107
             data     29
             sms      94
    2014-12  call     79
             data     30
             sms      48
    2015-01  call     88
             data     31
             sms      86
    2015-02  call     67
             data     31
             sms      39
    2015-03  call     47
             data     29
             sms      25
    Name: date, dtype: int64




```python
df_phone.groupby(['month', 'item'])['date'].count().unstack()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>item</th>
      <th>call</th>
      <th>data</th>
      <th>sms</th>
    </tr>
    <tr>
      <th>month</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2014-11</th>
      <td>107</td>
      <td>29</td>
      <td>94</td>
    </tr>
    <tr>
      <th>2014-12</th>
      <td>79</td>
      <td>30</td>
      <td>48</td>
    </tr>
    <tr>
      <th>2015-01</th>
      <td>88</td>
      <td>31</td>
      <td>86</td>
    </tr>
    <tr>
      <th>2015-02</th>
      <td>67</td>
      <td>31</td>
      <td>39</td>
    </tr>
    <tr>
      <th>2015-03</th>
      <td>47</td>
      <td>29</td>
      <td>25</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_phone.groupby('month', as_index = False).agg({'duration' : 'sum'})
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>month</th>
      <th>duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2014-11</td>
      <td>26639.441</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2014-12</td>
      <td>14641.870</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2015-01</td>
      <td>18223.299</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2015-02</td>
      <td>15522.299</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2015-03</td>
      <td>22750.441</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_phone.groupby(['month', 'item']).agg({'duration' : sum,
                                         'network_type' : 'count',
                                         'date' : 'first'})
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>duration</th>
      <th>network_type</th>
      <th>date</th>
    </tr>
    <tr>
      <th>month</th>
      <th>item</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">2014-11</th>
      <th>call</th>
      <td>25547.000</td>
      <td>107</td>
      <td>2014-10-15 06:58:00</td>
    </tr>
    <tr>
      <th>data</th>
      <td>998.441</td>
      <td>29</td>
      <td>2014-10-15 06:58:00</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>94.000</td>
      <td>94</td>
      <td>2014-10-16 22:18:00</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2014-12</th>
      <th>call</th>
      <td>13561.000</td>
      <td>79</td>
      <td>2014-11-14 17:24:00</td>
    </tr>
    <tr>
      <th>data</th>
      <td>1032.870</td>
      <td>30</td>
      <td>2014-11-13 06:58:00</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>48.000</td>
      <td>48</td>
      <td>2014-11-14 17:28:00</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2015-01</th>
      <th>call</th>
      <td>17070.000</td>
      <td>88</td>
      <td>2014-12-15 20:03:00</td>
    </tr>
    <tr>
      <th>data</th>
      <td>1067.299</td>
      <td>31</td>
      <td>2014-12-13 06:58:00</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>86.000</td>
      <td>86</td>
      <td>2014-12-15 19:56:00</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2015-02</th>
      <th>call</th>
      <td>14416.000</td>
      <td>67</td>
      <td>2015-01-15 10:36:00</td>
    </tr>
    <tr>
      <th>data</th>
      <td>1067.299</td>
      <td>31</td>
      <td>2015-01-13 06:58:00</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>39.000</td>
      <td>39</td>
      <td>2015-01-15 12:23:00</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2015-03</th>
      <th>call</th>
      <td>21727.000</td>
      <td>47</td>
      <td>2015-02-12 20:15:00</td>
    </tr>
    <tr>
      <th>data</th>
      <td>998.441</td>
      <td>29</td>
      <td>2015-02-13 06:58:00</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>25.000</td>
      <td>25</td>
      <td>2015-02-19 18:46:00</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_phone.groupby(['month', 'item']).agg({'duration' : [min, max, sum],
                                     'network_type' : "count",
                                     'date' : [min, 'first', 'nunique']})
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="3" halign="left">duration</th>
      <th>network_type</th>
      <th colspan="3" halign="left">date</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>sum</th>
      <th>count</th>
      <th>min</th>
      <th>first</th>
      <th>nunique</th>
    </tr>
    <tr>
      <th>month</th>
      <th>item</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">2014-11</th>
      <th>call</th>
      <td>1.000</td>
      <td>1940.000</td>
      <td>25547.000</td>
      <td>107</td>
      <td>2014-10-15 06:58:00</td>
      <td>2014-10-15 06:58:00</td>
      <td>104</td>
    </tr>
    <tr>
      <th>data</th>
      <td>34.429</td>
      <td>34.429</td>
      <td>998.441</td>
      <td>29</td>
      <td>2014-10-15 06:58:00</td>
      <td>2014-10-15 06:58:00</td>
      <td>29</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>1.000</td>
      <td>1.000</td>
      <td>94.000</td>
      <td>94</td>
      <td>2014-10-16 22:18:00</td>
      <td>2014-10-16 22:18:00</td>
      <td>79</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2014-12</th>
      <th>call</th>
      <td>2.000</td>
      <td>2120.000</td>
      <td>13561.000</td>
      <td>79</td>
      <td>2014-11-14 17:24:00</td>
      <td>2014-11-14 17:24:00</td>
      <td>76</td>
    </tr>
    <tr>
      <th>data</th>
      <td>34.429</td>
      <td>34.429</td>
      <td>1032.870</td>
      <td>30</td>
      <td>2014-11-13 06:58:00</td>
      <td>2014-11-13 06:58:00</td>
      <td>30</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>1.000</td>
      <td>1.000</td>
      <td>48.000</td>
      <td>48</td>
      <td>2014-11-14 17:28:00</td>
      <td>2014-11-14 17:28:00</td>
      <td>41</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2015-01</th>
      <th>call</th>
      <td>2.000</td>
      <td>1859.000</td>
      <td>17070.000</td>
      <td>88</td>
      <td>2014-12-15 20:03:00</td>
      <td>2014-12-15 20:03:00</td>
      <td>84</td>
    </tr>
    <tr>
      <th>data</th>
      <td>34.429</td>
      <td>34.429</td>
      <td>1067.299</td>
      <td>31</td>
      <td>2014-12-13 06:58:00</td>
      <td>2014-12-13 06:58:00</td>
      <td>31</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>1.000</td>
      <td>1.000</td>
      <td>86.000</td>
      <td>86</td>
      <td>2014-12-15 19:56:00</td>
      <td>2014-12-15 19:56:00</td>
      <td>58</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2015-02</th>
      <th>call</th>
      <td>1.000</td>
      <td>1863.000</td>
      <td>14416.000</td>
      <td>67</td>
      <td>2015-01-15 10:36:00</td>
      <td>2015-01-15 10:36:00</td>
      <td>67</td>
    </tr>
    <tr>
      <th>data</th>
      <td>34.429</td>
      <td>34.429</td>
      <td>1067.299</td>
      <td>31</td>
      <td>2015-01-13 06:58:00</td>
      <td>2015-01-13 06:58:00</td>
      <td>31</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>1.000</td>
      <td>1.000</td>
      <td>39.000</td>
      <td>39</td>
      <td>2015-01-15 12:23:00</td>
      <td>2015-01-15 12:23:00</td>
      <td>27</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2015-03</th>
      <th>call</th>
      <td>2.000</td>
      <td>10528.000</td>
      <td>21727.000</td>
      <td>47</td>
      <td>2015-02-12 20:15:00</td>
      <td>2015-02-12 20:15:00</td>
      <td>47</td>
    </tr>
    <tr>
      <th>data</th>
      <td>34.429</td>
      <td>34.429</td>
      <td>998.441</td>
      <td>29</td>
      <td>2015-02-13 06:58:00</td>
      <td>2015-02-13 06:58:00</td>
      <td>29</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>1.000</td>
      <td>1.000</td>
      <td>25.000</td>
      <td>25</td>
      <td>2015-02-19 18:46:00</td>
      <td>2015-02-19 18:46:00</td>
      <td>17</td>
    </tr>
  </tbody>
</table>
</div>




```python
grouped = df_phone.groupby('month').agg( {"duration" : [min, max, np.mean]})

grouped.columns = grouped.columns.droplevel(level = 0)

grouped.rename(columns = {"min" : "min_duration",
                          "max" : "max_duration",
                          "mean" : "mean_duration"})
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min_duration</th>
      <th>max_duration</th>
      <th>mean_duration</th>
    </tr>
    <tr>
      <th>month</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2014-11</th>
      <td>1.0</td>
      <td>1940.0</td>
      <td>115.823657</td>
    </tr>
    <tr>
      <th>2014-12</th>
      <td>1.0</td>
      <td>2120.0</td>
      <td>93.260318</td>
    </tr>
    <tr>
      <th>2015-01</th>
      <td>1.0</td>
      <td>1859.0</td>
      <td>88.894141</td>
    </tr>
    <tr>
      <th>2015-02</th>
      <td>1.0</td>
      <td>1863.0</td>
      <td>113.301453</td>
    </tr>
    <tr>
      <th>2015-03</th>
      <td>1.0</td>
      <td>10528.0</td>
      <td>225.251891</td>
    </tr>
  </tbody>
</table>
</div>



### Pivot Table
- 우리가 Excel에서 보던 그것
- index축은 groupby와 동일
- column에 추가로 labelling 값을 추가하여,<br/>
value에 numeric type값을 aggregation하는 형태


```python
df_phone = pd.read_csv("./data/phone_data.csv")
df_phone['date'] = df_phone['date'].apply(dateutil.parser.parse, dayfirst = True)
df_phone.head()
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>date</th>
      <th>duration</th>
      <th>item</th>
      <th>month</th>
      <th>network</th>
      <th>network_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>2014-10-15 06:58:00</td>
      <td>34.429</td>
      <td>data</td>
      <td>2014-11</td>
      <td>data</td>
      <td>data</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2014-10-15 06:58:00</td>
      <td>13.000</td>
      <td>call</td>
      <td>2014-11</td>
      <td>Vodafone</td>
      <td>mobile</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>2014-10-15 14:46:00</td>
      <td>23.000</td>
      <td>call</td>
      <td>2014-11</td>
      <td>Meteor</td>
      <td>mobile</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>2014-10-15 14:48:00</td>
      <td>4.000</td>
      <td>call</td>
      <td>2014-11</td>
      <td>Tesco</td>
      <td>mobile</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>2014-10-15 17:27:00</td>
      <td>4.000</td>
      <td>call</td>
      <td>2014-11</td>
      <td>Tesco</td>
      <td>mobile</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_phone.pivot_table(["duration"],
                     index = [df_phone.month,df_phone.item],
                     columns = df_phone.network, aggfunc = "sum", fill_value = 0)
```




<div>

<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="9" halign="left">duration</th>
    </tr>
    <tr>
      <th></th>
      <th>network</th>
      <th>Meteor</th>
      <th>Tesco</th>
      <th>Three</th>
      <th>Vodafone</th>
      <th>data</th>
      <th>landline</th>
      <th>special</th>
      <th>voicemail</th>
      <th>world</th>
    </tr>
    <tr>
      <th>month</th>
      <th>item</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">2014-11</th>
      <th>call</th>
      <td>1521</td>
      <td>4045</td>
      <td>12458</td>
      <td>4316</td>
      <td>0.000</td>
      <td>2906</td>
      <td>0</td>
      <td>301</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>998.441</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>10</td>
      <td>3</td>
      <td>25</td>
      <td>55</td>
      <td>0.000</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2014-12</th>
      <th>call</th>
      <td>2010</td>
      <td>1819</td>
      <td>6316</td>
      <td>1302</td>
      <td>0.000</td>
      <td>1424</td>
      <td>0</td>
      <td>690</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1032.870</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>12</td>
      <td>1</td>
      <td>13</td>
      <td>18</td>
      <td>0.000</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2015-01</th>
      <th>call</th>
      <td>2207</td>
      <td>2904</td>
      <td>6445</td>
      <td>3626</td>
      <td>0.000</td>
      <td>1603</td>
      <td>0</td>
      <td>285</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1067.299</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>10</td>
      <td>3</td>
      <td>33</td>
      <td>40</td>
      <td>0.000</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2015-02</th>
      <th>call</th>
      <td>1188</td>
      <td>4087</td>
      <td>6279</td>
      <td>1864</td>
      <td>0.000</td>
      <td>730</td>
      <td>0</td>
      <td>268</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1067.299</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>1</td>
      <td>2</td>
      <td>11</td>
      <td>23</td>
      <td>0.000</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2015-03</th>
      <th>call</th>
      <td>274</td>
      <td>973</td>
      <td>4966</td>
      <td>3513</td>
      <td>0.000</td>
      <td>11770</td>
      <td>0</td>
      <td>231</td>
      <td>0</td>
    </tr>
    <tr>
      <th>data</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>998.441</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>sms</th>
      <td>0</td>
      <td>4</td>
      <td>5</td>
      <td>13</td>
      <td>0.000</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>
